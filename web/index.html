<!DOCTYPE html>
<head>
	<title>Hello</title>
</head>
<body>
	<div>
		<label for="game_username">Username</label>
		<input id="game_username" type="text" autocomplete="off" spellcheck="false" placeholder="Username"></input>
		<button onclick="gameLogin()">Join</button>
	</div>
	<div>
		Viewers:
		<span id="game_viewers">?</span>
	</div>
	<script src="gmt.js"></script>
	<script>
		// B Y T E   R / W
		class ByteReader {
			constructor(buffer) {
				this.dv = new DataView(buffer);
				this.i = 0;
			}
			u8()   { const r = this.dv.getUint8(this.i);        this.i += 1; return r; }
			u16()  { const r = this.dv.getUint16(this.i, true); this.i += 2; return r; }
			u32()  { const r = this.dv.getUint32(this.i, true); this.i += 4; return r; }
			u64()  { const r = this.dv.getUint64(this.i, true); this.i += 8; return r; }
			str(n) { const str = new TextDecoder().decode(new Uint8Array(this.dv.buffer, this.i, n)); this.i += n; return str; }
		}
		class ByteWriter {
			constructor() {
				this.arr = [];
				this.dv = new DataView(new ArrayBuffer(8))
			}
			u8(v)  { this.arr.push(v); }
			u16(v) { this.dv.setUint16(0, v, true); this.arr.push(...new Uint8Array(this.dv.buffer, 0, 2)); }
			u32(v) { this.dv.setUint16(0, v, true); this.arr.push(...new Uint8Array(this.dv.buffer, 0, 4)); }
			u64(v) { this.dv.setUint16(0, v, true); this.arr.push(...new Uint8Array(this.dv.buffer, 0, 8)); }
			str(s) {
				const te = new TextEncoder().encode(s);
				this.u32(te.length);
				this.arr.push(...te);
			}
			bytes() { return new Uint8Array(this.arr); }
		}
		// E L E M E N T S
		const viewersEl = document.getElementById("game_viewers");
		const usernameEl = document.getElementById("game_username");
		// L O G I N
		function gameLogin() {
			const writer = new ByteWriter();
			writer.u8(GCMT.LOGIN);
			writer.str(usernameEl.value);
			ws.send(writer.bytes())
		}
		// W E B S O C K E T S
		const ws = new WebSocket(`ws://${location.host}/ws`);
		ws.binaryType = "arraybuffer";
		ws.onopen = () => { console.log('WS: open'); };
		ws.onmessage = (event) => {
			const reader = new ByteReader(event.data);
			msg_type = reader.u8();
			if (msg_type == GSMT.INFO_VIEWERS) {
				const viewer_count = reader.u32();
				console.log("viewers: "+viewer_count);
				viewersEl.textContent = viewer_count;
			}
		}
	</script>
</body>
