<!DOCTYPE html>
<head>
	<title>Hello</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		html { font-size: 20px; }
		/*body * { border: solid 1px red; }*/
		:root { /* Inspiration: sajid */
			--primary:    #01fdf2;
			--text:       #fff5f5;
			--text-muted: #909295;
			--bg-dark:    #090909;
			--bg:         #151514;
			--bg-light:   #272727;
			--shadow-s: inset 0 1px 2px #ffffff30, 0 1px 2px #00000030, 0 2px 4px #00000015;
			--shadow-m: inset 0 1px 2px #ffffff50, 0 2px 4px #00000030, 0 4px 8px #00000015; 
			--shadow-l: inset 0 1px 2px #ffffff70, 0 4px 6px #00000030, 0 6px 10px #00000015;
			--shadow-s-in: inset 0 -1px 1px #ffffff30, 0 1px 2px #00000030, 0 2px 4px #00000015;
			--shadow-m-in: inset 0 -1px 1px #ffffff50, 0 2px 4px #00000030, 0 4px 8px #00000015; 
			--shadow-l-in: inset 0 -1px 1px #ffffff70, 0 4px 6px #00000030, 0 6px 10px #00000015;
			--gradient-bg: linear-gradient(0deg, var(--bg), var(--bg-light));
			--gradient-bg-h: linear-gradient(-90deg, var(--bg), var(--bg-light));
			--shadow-text-s: 0.07rem 0.07rem 0.0rem var(--bg-light);
		}
		@media (prefers-color-scheme: light) {
			:root {
				--primary:    #fe5060;
				--text:       #010203;
				--text-muted: #6d6d6d;
				--bg-dark:    #e5e4de;
				--bg:         #f2efe5;
				--bg-light:   #fefeff;
			}
		}
		body {
			margin: 0;
			min-height: 100vh;
			background-color: var(--bg-dark);
			color: var(--text);
		}
		/* --- Generic elements --- */
		.game_nav {
			width: 100%;
			height: 48px;
			display: flex;
			justify-content: center;
			align-items: center;
			top: 0;
			z-index: 1000;
			background-color: var(--bg);
		}
		.game_nav * {
			display: flex;
			align-items: center;
			margin: 0 10px 0 10px;
		}
		#game_logo {
			font-size: 32px;
		}
		.game_content {
			padding-top: 40px;
			display: flex;
			flex-flow: column;
			justify-content: flex-start;
			align-items: center;
			width: 100vw;
			box-sizing: border-box; /* No shrinking */
			overflow: hidden;
		}
		.game_box {
			width: clamp(50%, 600px, 85%);
			height: 100%;
			padding: 24px 1.25rem 32px 1.25rem;
			border-radius: 15px;
			background-color: var(--bg);
			box-shadow: var(--shadow-s);
			text-shadow: var(--shadow-text-s);
		}
		.game_box span { font-size: 1rem; }
		.game_box h1 { font-size: 2.5rem; text-align: center; }
		.game_box h2 { font-size: 2rem; text-align: center; }
		.game_box h3 { font-size: 1.5rem; text-align: center; }
		.game_box input {
			font-size: 1rem;
			margin: 0.1rem 0.2rem;
			padding: 0.2rem 0.5rem;
			color: var(--text);
			background: var(--bg-light);	
			box-shadow: var(--shadow-s-in);
			border: none;
			border-radius: 3px;
			transition: var(--ease);
		}
		.game_box input:focus {
			outline: none;
			box-shadow: var(--shadow-m-in);
		}
		.game_box input:disabled { color: var(--text-muted) }
		button {
			margin: 0.1rem 0.2rem;
			font-size: 1rem;
			padding: 0.2rem 0.5rem;
			background: var(--bg-light);	
			box-shadow: var(--shadow-s);
			border: none;
			border-radius: 3px;
			color: var(--text);
			transition: var(--ease);
		}
		.game_box button:hover {
			box-shadow: var(--shadow-l);
		}
		.game_box button:active {
			box-shadow: var(--shadow-s-in);
			transform: scale(0.98);
		}
		.game_box button:disabled {
			pointer-events: none;
			color: var(--text-muted)
		}
		/* --- Player List --- */
		#players_list {
			display: block;
			width: 100%;
		}
		.player_entry {
			display: flex;
			justify-content: flex-start;
			align-items: center;
			height: 2rem;
			background: var(--bg-light);	
		}
		/* --- Joining --- */
		.game_join {
			display: flex;
			flex-flow: row;
			flex-wrap: wrap;
			justify-content: center;
			margin: 10px;
			padding: 5px;
		}
		#game_lobby {
		}
		#game_chat {
			display: none;
		}
		.game_chat_content {
			max-height: 60vh;
			overflow-y: auto;
			overflow-x: hidden;
		}
	</style>
</head>
<body>
	<nav class="game_nav">
		<span id="game_logo">
			LANfia
		</span>
		<button id="lobby_button" onclick="ToggleLobby(!is_lobby)"></button>
	</nav>
	<div class="game_content">
		<div class="game_box">
			<div id="game_lobby">
				<div class="game_join" style="">
					<label for="game_username"></label>
					<input id="game_username" type="text" autocomplete="off" spellcheck="false" placeholder="Username"></input>
					<button id="join_button" onclick="SendGameJoin()">Join</button>
					<button id="leave_button" onclick="SendGameLeave()" style="display: none;">Leave</button>
					<button id="ready_button" onclick="SendGameReady()" style="display: none;"></button>
				</div>
				<div style="display: flex; margin: 8px;">
					<span id="game_join_error" style="color: tomato;"></span>
					<span id="players_none" style="color: var(--text-muted);">No players yet...</span>
				</div>
				<div id="players_list">
				</div>
				<hr>
				<div style="display: flex;">
					<span>Viewers:</span>&nbsp;<span id="game_viewers">?</span>
				</div>
				<div class="box">
				</div>
			</div>
			<div id="game_chat">
				<div class="game_chat_content">
				</div>
			</div>
		</div>
	</div>
	<script src="gmt.js"></script>
	<script src="utils.js"></script>
	<script src="templates.js"></script>
	<script>
		// --- Variables ---
		var ready = false;
		var ready_next = false;
		var player_names = [];
		var player_states = "";
		var player_next_count = 0;
		var game_started = false;
		var is_lobby = true;
		var player_role = -1;
		var is_player = false;
		// --- Elements ---
		const viewersEl = document.getElementById("game_viewers");
		const playersListEl = document.getElementById("players_list");
		const usernameEl = document.getElementById("game_username");
		const joinErrorEl = document.getElementById("game_join_error");
		const readyButtonEl = document.getElementById("ready_button");
		const lobbyButtonEl = document.getElementById("lobby_button");
		const gameLobby = document.getElementById("game_lobby");
		const gameChat = document.getElementById("game_chat");
		function ReadyNextButtonUpdate() {
			const readyNextButton = document.getElementById("ready_next_button");
			if (!readyNextButton) { return; }
			ready_next_button.disabled = !is_player;
			readyNextButton.innerHTML = `${ready_next ? "Not ready" : "Ready"} (${player_next_count}/${player_names.length})`;
		}
		function ReadyNextButtonDelete() {
			var readyNextButton = document.getElementById("ready_next_button");
			if (readyNextButton) { readyNextButton.remove(); }
		}
		function ToggleLobby(state) {
			if (state) {
				gameChat.style.display = "none";
				gameLobby.style.display = "unset";
				lobbyButtonEl.innerHTML = "To game";
			} else {
				gameChat.style.display = "unset";
				gameLobby.style.display = "none";
				lobbyButtonEl.innerHTML = "To lobby";
			}
			is_lobby = state;
		}
		ToggleLobby(true);
		function ToggleJoin(state) {
			if (state) {
				document.getElementById("join_button").style.display  = "none";
				document.getElementById("leave_button").style.display = "unset";
				document.getElementById("ready_button").style.display = "unset";
				usernameEl.disabled = true;
			} else {
				document.getElementById("join_button").style.display  = "unset";
				document.getElementById("leave_button").style.display = "none";
				document.getElementById("ready_button").style.display = "none";
				usernameEl.disabled = false;
			}
		}
		function ToggleReady(state) {
			ready = state;
			document.getElementById("ready_button").innerHTML = !ready ? "Ready" : "Not ready";
		}
		ToggleReady(false);
		// --- Server Message Send ---
		function SendGameJoin() {
			const writer = new ByteWriter();
			writer.u8(GCMT.LOBBY_JOIN);
			writer.strn(usernameEl.value);
			ws.send(writer.bytes())
		}
		function SendGameLeave() {
			const writer = new ByteWriter();
			writer.u8(GCMT.LOBBY_LEAVE);
			ws.send(writer.bytes())
		}
		function SendGameReady() {
			const writer = new ByteWriter();
			ToggleReady(!ready);
			writer.u8(GCMT.LOBBY_READY);
			writer.u8(ready);
			ws.send(writer.bytes())
		}
		function SendGameReadyNext() {
			const writer = new ByteWriter();
			ready_next = !ready_next;
			writer.u8(GCMT.READY_NEXT);
			writer.u8(ready_next);
			ws.send(writer.bytes())
		}
		// --- Generate HTML ---
		function GetTextReadyNext() {
			return templReadyNextButton;
		}
		// --- Server Message Handlers ---
		function HandleServerInfoUsers(reader) {
			const viewer_count = reader.u32();
			const player_count = reader.u32();
			player_names = reader.strn().split('\0');
			player_states = reader.strn();
			player_names.pop();
			playersListEl.innerHTML = "";
			const playersNoneEl = document.getElementById("players_none");
			playersNoneEl.style.display = player_names.length == 0 ? "unset" : "none";
			for (const i in player_names) {
				playersListEl.innerHTML += eval(`\`${templPlayerListEntry}\``);
			}
			viewersEl.textContent = viewer_count;
		}
		function HandleServerInfoReadyNext(reader) {
			const all_ready = reader.u8();
			player_next_count = reader.u32();
			if (all_ready) { ready_next = false; }
			ReadyNextButtonUpdate();
		}
		function HandleServerGameAction(reader) {
			const action = reader.u8();
			var msgEl = document.createElement('div');
			msgEl.className = "game_chat_msg";
			switch (action) {
				case GAT.CLEAR:
					gameChat.innerHTML = "";
					return;
				case GAT.STARTED:
					readyButtonEl.disabled = true;
					game_started = true;
					ToggleLobby(false);
					readyButtonEl.style.display = "none";
					msgEl.innerHTML += templGameStarted;
					if (is_player) {
						msgEl.innerHTML += templGameStartedPlayerNote;
					} else {
						msgEl.innerHTML += templGameStartedSpectatorNote;
					}
					break;
				case GAT.ROLE:
					const role_type = reader.u8();
					player_role = role_type;
					role_name = "";
					switch (player_role) {
						case GRT.VILLAGER: role_name += templRoleVillager; break;
						case GRT.MAFIA:    role_name += templRoleMafia; break;
						case GRT.SERIF:    role_name += templRoleSerif; break;
						case GRT.DOCTOR:   role_name += templRoleDoctor; break;
						case GRT.ESCORT:   role_name += templRoleEscort; break;
						case GRT.MANIAC:   role_name += templRoleManiac; break;
					}
					msgEl.innerHTML += eval(`\`${templGameActionRole}\``);
					break;
				case GAT.DAY_STARTED:
					ReadyNextButtonDelete();
					msgEl.innerHTML += templDayStarted;
					msgEl.innerHTML += GetTextReadyNext();
					break;
				case GAT.DAY_ENDED:
					msgEl.innerHTML += GetTextReadyNext();
					break;
				case GAT.NIGHT_STARTED:
					ReadyNextButtonDelete();
					msgEl.innerHTML += templNightStarted;
					if (!is_player) {
						msgEl.innerHTML += templChoicesNote;
					}
					break;
				case GAT.NIGHT_ROLE_ACTION:
					var role = reader.u8();
					msgEl.innerHTML += templRoleTasks[role];
					switch (role) {
						case GRT.VILLAGER:
							break;
						case GRT.MAFIA:
							break;
						case GRT.SERIF:
							break;
						case GRT.DOCTOR:
							break;
						case GRT.ESCORT:
							break;
						case GRT.MANIAC:
							break;
					}
					msgEl.innerHTML += GetTextReadyNext();
					break;
				case GAT.RESULTS:
					msgEl.innerHTML += "";
					break;
				// TODO: on end:
				// readyButtonEl.disabled = false;
				// game_started = false;
				// ToggleLobby(true);
				default:
					return;
			}
			gameChat.appendChild(msgEl);
			ReadyNextButtonUpdate();
		}
		function HandleServerGameConfirm(reader) {
			confirm_type = reader.u8();
			switch (confirm_type) {
				case GC.JOIN_SUCCESS:
					joinErrorEl.innerHTML = "";
					ToggleJoin(true);
					ToggleReady(false);
					is_player = true;
					break;
				case GC.LEAVE_SUCCESS:
					joinErrorEl.innerHTML = "";
					ToggleJoin(false);
					ToggleReady(false);
					is_player = false;
					break;
			}
		}
		function HandleServerGameError(reader) {
			err_type = reader.u8();
			switch (err_type) {
				case GE.JOIN_GAME_IN_PROGRESS:
				case GE.LEAVE_GAME_IN_PROGRESS:
					joinErrorEl.innerHTML = "Game already started";
					break;
				case GE.JOIN_NAME_TOO_LONG:
					joinErrorEl.innerHTML = "Name too long";
					break;
			}
		}
		// --- WebSockets ---
		const ws = new WebSocket(`ws://${location.host}/ws`);
		ws.binaryType = "arraybuffer";
		ws.onopen = () => {
			//console.log('WS: open');
		};
		ws.onmessage = (event) => {
			const reader = new ByteReader(event.data);
			msg_type = reader.u8();
			switch (msg_type) {
				case GSMT.INFO_USERS:      HandleServerInfoUsers(reader); break;
				case GSMT.INFO_READY_NEXT: HandleServerInfoReadyNext(reader); break;
				case GSMT.ERROR:           HandleServerGameError(reader); break;
				case GSMT.CONFIRM:         HandleServerGameConfirm(reader); break;
				case GSMT.GAME_ACTION:     HandleServerGameAction(reader); break;
			}
		}
	</script>
</body>
