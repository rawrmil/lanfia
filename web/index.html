<!DOCTYPE html>
<head>
	<title>Hello</title>
	<style>
		/*body * { border: solid 1px red; }*/
		:root { /* Inspiration: sajid */
			--primary:    #01fdf2;
			--text:       #fff5f5;
			--text-muted: #909295;
			--bg-dark:    #090909;
			--bg:         #151514;
			--bg-light:   #272727;
			--shadow-s: inset 0 1px 2px #ffffff30, 0 1px 2px #00000030, 0 2px 4px #00000015;
			--shadow-m: inset 0 1px 2px #ffffff50, 0 2px 4px #00000030, 0 4px 8px #00000015; 
			--shadow-l: inset 0 1px 2px #ffffff70, 0 4px 6px #00000030, 0 6px 10px #00000015;
			--shadow-s-in: inset 0 -1px 1px #ffffff30, 0 1px 2px #00000030, 0 2px 4px #00000015;
			--shadow-m-in: inset 0 -1px 1px #ffffff50, 0 2px 4px #00000030, 0 4px 8px #00000015; 
			--shadow-l-in: inset 0 -1px 1px #ffffff70, 0 4px 6px #00000030, 0 6px 10px #00000015;
			--gradient-bg: linear-gradient(0deg, var(--bg), var(--bg-light));
			--gradient-bg-h: linear-gradient(-90deg, var(--bg), var(--bg-light));
			--shadow-text-s: 0.07rem 0.07rem 0.0rem var(--bg-light);
		}
		@media (prefers-color-scheme: light) {
			:root {
				--primary:    #fe5060;
				--text:       #010203;
				--text-muted: #6d6d6d;
				--bg-dark:    #e5e4de;
				--bg:         #f2efe5;
				--bg-light:   #fefeff;
			}
		}
		body {
			margin: 0;
			min-height: 100vh;
			background-color: var(--bg-dark);
			color: var(--text);
		}
		.game_nav {
			width: 100%;
			height: 48px;
			display: flex;
			justify-content: center;
			align-items: center;
			top: 0;
			z-index: 1000;
			background-color: var(--bg);
		}
		.game_nav * {
			display: flex;
			align-items: center;
			margin: 0 10px 0 10px;
		}
		#game_logo {
			font-size: 32px;
		}
		.game_content {
			padding-top: 40px;
			display: flex;
			flex-flow: column;
			justify-content: flex-start;
			align-items: center;
			width: 100vw;
			box-sizing: border-box; /* No shrinking */
			overflow: hidden;
		}
		.game_box {
			width: clamp(50%, 600px, 85%);
			height: 100%;
			font-size: 24px;
			line-height: 1.6;
			margin: 10px;
			padding: 24px 1.25rem 32px 1.25rem;
			border-radius: 15px;
			background-color: var(--bg);
			box-shadow: var(--shadow-s);
			text-shadow: var(--shadow-text-s);
			width: clamp(50%, 600px, 85%);
			height: 100%;
			line-height: 1.6;
			margin: 10px;
		}
		.game_box h1 { font-size: 2.5rem; }
		.game_box h2 { font-size: 2rem; }
		.game_box h3 { font-size: 1.5rem; }
		.game_box input {
			font-size: 1rem;
			margin: 0.1rem 0.2rem;
			padding: 0.2rem 0.5rem;
			color: var(--text);
			background: var(--bg-light);	
			box-shadow: var(--shadow-s-in);
			border: none;
			border-radius: 3px;
			transition: var(--ease);
		}
		.game_box input:focus {
			outline: none;
			box-shadow: var(--shadow-m-in);
		}
		.game_box button {
			margin: 0.1rem 0.2rem;
			font-size: 1rem;
			padding: 0.2rem 0.5rem;
			background: var(--bg-light);	
			box-shadow: var(--shadow-s);
			border: none;
			border-radius: 3px;
			color: var(--text);
			transition: var(--ease);
		}
		.game_box button:hover {
			box-shadow: var(--shadow-l);
		}
		.game_box button:active {
			box-shadow: var(--shadow-s-in);
			transform: scale(0.98);
		}
		#players_list {
			display: block;
			width: 100%;
		}
		.player_entry {
			background: var(--bg-light);	
		}
	</style>
</head>
<body>
	<nav class="game_nav">
		<span id="game_logo">
			LANfia
		</span>
	</nav>
	<div class="game_content">
		<div class="game_box">
			<h1>Players</h1>
			<div class="game_join" style="display: flex; flex-flow: row; justify-content: center; margin: 10px;">
				<label for="game_username"></label>
				<input id="game_username" type="text" autocomplete="off" spellcheck="false" placeholder="Username"></input>
				<button onclick="gameLogin()">Join</button>
			</div>
			<div id="players_list">
			</div>
			<hr>
			<div>
				Viewers:
				<span id="game_viewers">?</span>
			</div>
			<div class="box">
			</div>
		</div>
	</div>
	<script src="gmt.js"></script>
	<script>
		// U T I L S
		function Escaped(str) {
			return str.replace(/&/g, '&amp;')
				.replace(/</g, '&lt;')
				.replace(/>/g, '&gt;')
				.replace(/"/g, '&quot;')
				.replace(/'/g, '&#39;');
		}
		// B Y T E   R / W
		class ByteReader {
			constructor(buffer) {
				this.dv = new DataView(buffer);
				this.i = 0;
			}
			u8()   { const r = this.dv.getUint8(this.i);        this.i += 1; return r; }
			u16()  { const r = this.dv.getUint16(this.i, true); this.i += 2; return r; }
			u32()  { const r = this.dv.getUint32(this.i, true); this.i += 4; return r; }
			u64()  { const r = this.dv.getUint64(this.i, true); this.i += 8; return r; }
			str(n) {
				const str = new TextDecoder().decode(new Uint8Array(this.dv.buffer, this.i, n));
				this.i += n;
				return str;
			}
			strn() {
				var n = this.u32();
				return this.str(n);
			}
		}
		class ByteWriter {
			constructor() {
				this.arr = [];
				this.dv = new DataView(new ArrayBuffer(8))
			}
			bytes() { return new Uint8Array(this.arr); }
			u8(v)  { this.arr.push(v); }
			u16(v) { this.dv.setUint16(0, v, true); this.arr.push(...new Uint8Array(this.dv.buffer, 0, 2)); }
			u32(v) { this.dv.setUint16(0, v, true); this.arr.push(...new Uint8Array(this.dv.buffer, 0, 4)); }
			u64(v) { this.dv.setUint16(0, v, true); this.arr.push(...new Uint8Array(this.dv.buffer, 0, 8)); }
			strn(s) {
				const te = new TextEncoder().encode(s);
				this.u32(te.length);
				this.arr.push(...te);
			}
		}
		// E L E M E N T S
		const viewersEl = document.getElementById("game_viewers");
		const usernameEl = document.getElementById("game_username");
		const playersListEl = document.getElementById("players_list");
		// L O G I N
		function gameLogin() {
			const writer = new ByteWriter();
			writer.u8(GCMT.LOGIN);
			writer.strn(usernameEl.value);
			ws.send(writer.bytes())
		}
		// M E S S A G E S
		function HandleServerInfoUsers(reader) {
			const viewer_count = reader.u32();
			const player_count = reader.u32();
			const player_names = reader.strn().split('\0');
			player_names.pop();
			playersListEl.innerHTML = "";
			for (const i in player_names) {
				playersListEl.innerHTML +=
					`<div class='player_entry'>
						<span class='player_number'>${Number(i)+1}</span>
						<span class='player_name'>${Escaped(player_names[i]+"\n")}</span>
					</div>\n`;
			}
			viewersEl.textContent = viewer_count;
		}
		// W E B S O C K E T S
		const ws = new WebSocket(`ws://${location.host}/ws`);
		ws.binaryType = "arraybuffer";
		ws.onopen = () => {
			//console.log('WS: open');
		};
		ws.onmessage = (event) => {
			const reader = new ByteReader(event.data);
			msg_type = reader.u8();
			switch (msg_type) {
				case GSMT.INFO_USERS: HandleServerInfoUsers(reader); break;
			}
		}
	</script>
</body>
